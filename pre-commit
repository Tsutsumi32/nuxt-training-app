#!/bin/sh
#
# Git pre-commit hook
# ã‚³ãƒŸãƒƒãƒˆå‰ã«ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã«å¯¾ã—ã¦
# prettierã¨eslintã‚’å®Ÿè¡Œã—ã¦ã‚³ãƒ¼ãƒ‰ã‚’è‡ªå‹•æ•´å½¢ãƒ»ä¿®æ­£ã—ã¾ã™
# ï¼ˆDockerã‚³ãƒ³ãƒ†ãƒŠå†…ã§å®Ÿè¡Œï¼‰
#

# ============================================================================
# åˆæœŸè¨­å®š
# ============================================================================

# ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆãƒ«ãƒ¼ãƒˆãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’å–å¾—
ROOT_DIR="$(git rev-parse --show-toplevel)"
cd "$ROOT_DIR" || exit 1

# docker-compose.ymlãŒã‚ã‚‹ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ç‰¹å®š
if [ -f "docker-compose.yml" ]; then
  COMPOSE_DIR="$ROOT_DIR"
else
  echo "âŒ docker-compose.ymlãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“"
  exit 1
fi

# ============================================================================
# ç’°å¢ƒå¤‰æ•°ã®èª­ã¿è¾¼ã¿
# ============================================================================

# .envãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰ç’°å¢ƒå¤‰æ•°ã‚’èª­ã¿è¾¼ã‚€
if [ -f "$COMPOSE_DIR/.env" ]; then
  set -a
  . "$COMPOSE_DIR/.env"
  set +a
fi

# Docker Composeã‚µãƒ¼ãƒ“ã‚¹åï¼ˆ.envã‹ã‚‰èª­ã¿è¾¼ã¿ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯nuxtï¼‰
FRONT_CONTAINER="${FRONT_CONTAINER:-nuxt}"

# ã‚³ãƒ³ãƒ†ãƒŠåï¼ˆ.envã‹ã‚‰èª­ã¿è¾¼ã¿ã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯nuxt-portfolioï¼‰
CONTAINER_NAME="${CONTAINER_NAME:-nuxt-portfolio}"

# ============================================================================
# Dockerã‚³ãƒ³ãƒ†ãƒŠã®èµ·å‹•ç¢ºèª
# ============================================================================

cd "$COMPOSE_DIR" || exit 1

# ã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ã¦ã„ã‚‹ã‹ç¢ºèª
if ! docker ps --format "{{.Names}}" 2>/dev/null | grep -q "^${CONTAINER_NAME}$"; then
  echo "âš ï¸  Dockerã‚³ãƒ³ãƒ†ãƒŠãŒèµ·å‹•ã—ã¦ã„ã¾ã›ã‚“ã€‚èµ·å‹•ä¸­..."
  docker compose up -d "${FRONT_CONTAINER}" || exit 1
  sleep 2
fi

cd "$ROOT_DIR" || exit 1

# ============================================================================
# ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®å–å¾—ã¨åˆ†é¡ž
# ============================================================================

# ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ã‚’å–å¾—ï¼ˆè¿½åŠ ãƒ»å¤‰æ›´ãƒ»ãƒžãƒ¼ã‚¸ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ï¼‰
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

# ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã„å ´åˆã¯çµ‚äº†
if [ -z "$STAGED_FILES" ]; then
  exit 0
fi

# Nuxté–¢é€£ãƒ•ã‚¡ã‚¤ãƒ«ã‚’åˆ†é¡žï¼ˆVue, TS, JS, JSON, CSS, SCSSï¼‰
VUE_FILES=""
TS_FILES=""
JS_FILES=""
JSON_FILES=""
CSS_FILES=""
SCSS_FILES=""

for file in $STAGED_FILES; do
  # app/é…ä¸‹ã®ãƒ•ã‚¡ã‚¤ãƒ«ã®ã¿ã‚’å‡¦ç†å¯¾è±¡ã¨ã™ã‚‹
  if ! echo "$file" | grep -qE "^app/"; then
    continue
  fi
  
  # .nuxt, .output, node_modulesãªã©ã¯é™¤å¤–
  if echo "$file" | grep -qE "(\.nuxt|\.output|node_modules|dist)/"; then
    continue
  fi
  
  # app/ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’å‰Šé™¤ã—ã¦ã‚³ãƒ³ãƒ†ãƒŠå†…ã®ãƒ‘ã‚¹ã«å¤‰æ›
  container_file="${file#app/}"
  
  # Vueãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŠ½å‡º
  if echo "$file" | grep -qE "\.vue$"; then
    VUE_FILES="$VUE_FILES $container_file"
  fi
  
  # TypeScriptãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŠ½å‡º
  if echo "$file" | grep -qE "\.ts$"; then
    TS_FILES="$TS_FILES $container_file"
  fi
  
  # JavaScriptãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŠ½å‡º
  if echo "$file" | grep -qE "\.(js|cjs|mjs)$"; then
    JS_FILES="$JS_FILES $container_file"
  fi
  
  # JSONãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŠ½å‡º
  if echo "$file" | grep -qE "\.json$"; then
    JSON_FILES="$JSON_FILES $container_file"
  fi
  
  # CSSãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŠ½å‡º
  if echo "$file" | grep -qE "\.css$"; then
    CSS_FILES="$CSS_FILES $container_file"
  fi
  
  # SCSSãƒ•ã‚¡ã‚¤ãƒ«ã‚’æŠ½å‡º
  if echo "$file" | grep -qE "\.(scss|sass)$"; then
    SCSS_FILES="$SCSS_FILES $container_file"
  fi
done

# ============================================================================
# Prettierã«ã‚ˆã‚‹æ•´å½¢å‡¦ç†ï¼ˆã™ã¹ã¦ã®å¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
# ============================================================================

ALL_FORMAT_FILES="$VUE_FILES $TS_FILES $JS_FILES $JSON_FILES $CSS_FILES $SCSS_FILES"

if [ -n "$ALL_FORMAT_FILES" ]; then
  echo "ðŸ”§ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’Prettierã§æ•´å½¢ä¸­..."
  for file in $ALL_FORMAT_FILES; do
    # ã‚³ãƒ³ãƒ†ãƒŠå†…ã§prettierã‚’å®Ÿè¡Œã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ•´å½¢
    docker exec "${CONTAINER_NAME}" npx prettier --write "/app/${file}" 2>/dev/null || {
      echo "âš ï¸  app/${file} ã®æ•´å½¢ã«å¤±æ•—ã—ã¾ã—ãŸï¼ˆç„¡è¦–ã—ã¦ç¶šè¡Œï¼‰"
    }
    
    # æ•´å½¢å¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã«è¿½åŠ ï¼ˆapp/ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ ï¼‰
    git add "app/${file}" 2>/dev/null || true
  done
fi

# ============================================================================
# ESLintã«ã‚ˆã‚‹ä¿®æ­£å‡¦ç†ï¼ˆVue, TS, JSãƒ•ã‚¡ã‚¤ãƒ«ï¼‰
# ============================================================================

ALL_LINT_FILES="$VUE_FILES $TS_FILES $JS_FILES"

if [ -n "$ALL_LINT_FILES" ]; then
  echo "ðŸ”§ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ESLintã§ä¿®æ­£ä¸­..."
  for file in $ALL_LINT_FILES; do
    # .nuxt, .output, node_modulesãªã©ã¯é™¤å¤–
    if echo "$file" | grep -qE "(\.nuxt|\.output|node_modules|dist)/"; then
      continue
    fi
    
    # ã‚³ãƒ³ãƒ†ãƒŠå†…ã§eslint --fixã‚’å®Ÿè¡Œã—ã¦è‡ªå‹•ä¿®æ­£
    docker exec "${CONTAINER_NAME}" npx eslint --fix "/app/${file}" 2>/dev/null || {
      echo "âš ï¸  app/${file} ã®Lintãƒã‚§ãƒƒã‚¯ã§ã‚¨ãƒ©ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã—ãŸã€‚ä¿®æ­£ã—ã¦ã‹ã‚‰ã‚³ãƒŸãƒƒãƒˆã—ã¦ãã ã•ã„ã€‚"
      # ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚ç¶šè¡Œï¼ˆè‡ªå‹•ä¿®æ­£ã§ããªã„ã‚¨ãƒ©ãƒ¼ã®å ´åˆï¼‰
    }
    
    # ä¿®æ­£å¾Œã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¹ãƒ†ãƒ¼ã‚¸ãƒ³ã‚°ã«è¿½åŠ ï¼ˆapp/ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ã‚’è¿½åŠ ï¼‰
    git add "app/${file}" 2>/dev/null || true
  done
fi

exit 0
