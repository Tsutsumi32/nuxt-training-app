@use 'sass:map';
@use 'sass:meta';
@use 'sass:list';
@use '../variables/variables' as *;
@use '../functions/strip-unit' as *;
@use '../functions/vw-to-pixcel' as *;
@use './media' as *;

/******************************************************************
* style-settings-vars　値をセットするfunction(s)のためのCSS変数を生成する
* $style-settingsに基づいて、各ブレイクポイントで:rootにCSS変数(--liq-unit)を設定
* これにより、s()関数を使用した値が自動的にブレイクポイントで計算が変更される
* 各設定方法については、変数$style-settingsの箇所に記載する
* :root内でCSS変数を定義する
* @example
*   @include style-settings-vars;
*******************************************************************/
@mixin style-settings-vars() {
  :root {
    // デフォルト（最初のキーを動的に取得）
    $_default-key: list.nth(map.keys($style-settings), 1);
    $_default: map.get($style-settings, $_default-key);
    $_default-type: map.get($_default, 'type');
    $_default-base: map.get($_default, 'base-size');
    $_default-viewport-base: map.get($_default, 'viewport-base');

    // base-sizeが数値の場合はstrip-unit、文字列（計算値）の場合はそのまま使用
    $_default-base-value: null;
    @if meta.type-of($_default-base) == 'string' {
      $_default-base-value: $_default-base;
    } @else {
      $_default-base-value: strip-unit($_default-base);
    }
    $_default-viewport-base-stripped: strip-unit($_default-viewport-base);

    @if $_default-type == 'liquid' {
      --liq-unit: calc(#{$_default-base-value} / #{$_default-viewport-base-stripped} * 100vw);
    } @else if $_default-type == 'responsive' {
      // $min_layout_width以下ではvw、それ以上ではrem
      $_min-layout-width-stripped: strip-unit($min_layout_width);
      --liq-unit: min(
        calc(#{$_default-base-value} / #{$_min-layout-width-stripped} * 100vw),
        calc(#{$_default-base-value} / #{strip-unit($font-s_base)} * 1rem)
      );
    } @else if $_default-type == 'fixed' {
      $_default-fixed-width: map.get($_default, 'fixed-width');
      $_default-fixed-width-stripped: strip-unit($_default-fixed-width);
      $_font-s-base-stripped: strip-unit($font-s_base);
      // vw-to-pixelの計算式を展開してremに変換
      --liq-unit: calc(
        #{$_default-base-value} /
          #{$_default-viewport-base-stripped} *
          #{$_default-fixed-width-stripped} /
          #{$_font-s-base-stripped} *
          1rem
      );
    }
    // type='none'の場合は何もしない（前の値を継承）

    // 各ブレイクポイントを$breakpointsマップから動的に処理
    @each $key, $break-value in $breakpoints {
      @if map.has-key($style-settings, $key) {
        @include media($key) {
          $_setting: map.get($style-settings, $key);
          $_type: map.get($_setting, 'type');

          // type='none'の場合は何もしない（前の値を継承）
          @if $_type != 'none' {
            $_base: map.get($_setting, 'base-size');
            $_viewport-base: map.get($_setting, 'viewport-base');
            $_fixed-width: map.get($_setting, 'fixed-width');

            $_base-value: null;
            @if meta.type-of($_base) == 'string' {
              $_base-value: $_base;
            } @else {
              $_base-value: strip-unit($_base);
            }
            $_viewport-base-stripped: strip-unit($_viewport-base);

            @if $_type == 'liquid' {
              --liq-unit: calc(#{$_base-value} / #{$_viewport-base-stripped} * 100vw);
            } @else if $_type == 'responsive' {
              // $min_layout_width以下ではvw、それ以上ではrem
              $_min-layout-width-stripped: strip-unit($min_layout_width);
              --liq-unit: min(
                calc(#{$_base-value} / #{$_min-layout-width-stripped} * 100vw),
                calc(#{$_base-value} / #{strip-unit($font-s_base)} * 1rem)
              );
            } @else if $_type == 'fixed' {
              $_fixed-width-stripped: strip-unit($_fixed-width);
              $_font-s-base-stripped: strip-unit($font-s_base);
              // vw-to-pixelの計算式を展開してremに変換
              --liq-unit: calc(
                #{$_base-value} /
                  #{$_viewport-base-stripped} *
                  #{$_fixed-width-stripped} /
                  #{$_font-s-base-stripped} *
                  1rem
              );
            }
          }
        }
      }
    }
  }
}
