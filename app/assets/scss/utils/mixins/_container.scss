@use 'sass:map';
@use 'sass:meta';
@use '../variables/variables' as *;
@use '../functions/style-settings' as *;
@use './media' as *;

/******************************************************************
* container　コンテナの余白と最大幅を設定する
* @param $_type コンテナの種類（_variables.scssの$container-sizesで定義）
* $media_query_strategy で 'sp-first' または 'pc-first' を切り替え可能
*   - 'sp-first': SPをデフォルト、大きい画面で上書き
*   - 'pc-first': PCをデフォルト、小さい画面で上書き
*
* $container-sizesのキー名は$breakpointsのキー名と統一されています
*******************************************************************/
@mixin container($_type: 'normal') {
  // $container-sizesから指定されたタイプのサイズを取得
  @if not map.has-key($container-sizes, $_type) {
    @error "container(): 指定されたタイプ '#{$_type}' は $container-sizes に定義されていません。";
  }

  $_sizes: map.get($container-sizes, $_type);

  // デフォルト値を取得（メディアクエリを使用しない時の値）
  $_default: map.get($_sizes, 'default');
  @if $_default == null {
    @error "container(): '#{$_type}' に 'default' が定義されていません。";
  }
  $_default-padding: map.get($_default, 'padding');
  $_default-max-width: map.get($_default, 'max-width');

  margin-inline: auto;

  // SPファーストの場合
  @if $media_query_strategy == 'sp-first' {
    // デフォルト値を設定（メディアクエリなし）
    padding-inline: s($_default-padding);
    @if $_default-max-width != null {
      // max-width: 数値の場合はs()を使用、単位付きの場合はそのまま使用
      @if meta.type-of($_default-max-width) == 'number' {
        max-width: s($_default-max-width);
      } @else {
        max-width: $_default-max-width;
      }
    }

    // $breakpointsの各キーを順番に処理（小さい方から）
    @each $breakpoint-key in map.keys($breakpoints) {
      $_breakpoint-config: map.get($_sizes, $breakpoint-key);
      @if $_breakpoint-config != null {
        $_breakpoint-padding: map.get($_breakpoint-config, 'padding');
        $_breakpoint-max-width: map.get($_breakpoint-config, 'max-width');

        @include media($breakpoint-key) {
          @if $_breakpoint-padding != null {
            padding-inline: s($_breakpoint-padding);
          }
          @if $_breakpoint-max-width != null {
            // max-width: 数値の場合はs()を使用、単位付きの場合はそのまま使用
            @if meta.type-of($_breakpoint-max-width) == 'number' {
              max-width: s($_breakpoint-max-width);
            } @else {
              max-width: $_breakpoint-max-width;
            }
          }
        }
      }
    }
  } @else {
    // PCファーストの場合
    // デフォルト値を設定（メディアクエリなし）
    padding-inline: s($_default-padding);
    @if $_default-max-width != null {
      // max-width: 数値の場合はs()を使用、単位付きの場合はそのまま使用
      @if meta.type-of($_default-max-width) == 'number' {
        max-width: s($_default-max-width);
      } @else {
        max-width: $_default-max-width;
      }
    }

    // $breakpointsの各キーを逆順に処理（大きい方から）
    $breakpoint-keys: map.keys($breakpoints);
    @for $i from length($breakpoint-keys) through 1 {
      $breakpoint-key: nth($breakpoint-keys, $i);
      $_breakpoint-config: map.get($_sizes, $breakpoint-key);
      @if $_breakpoint-config != null {
        $_breakpoint-padding: map.get($_breakpoint-config, 'padding');
        $_breakpoint-max-width: map.get($_breakpoint-config, 'max-width');

        @include media($breakpoint-key) {
          @if $_breakpoint-padding != null {
            padding-inline: s($_breakpoint-padding);
          }
          @if $_breakpoint-max-width != null {
            // max-width: 数値の場合はs()を使用、単位付きの場合はそのまま使用
            @if meta.type-of($_breakpoint-max-width) == 'number' {
              max-width: s($_breakpoint-max-width);
            } @else {
              max-width: $_breakpoint-max-width;
            }
          }
        }
      }
    }
  }
}
